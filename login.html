<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="stylesheet" type="text/css" href="./css/login.css">
</head>

<body>
    <div class="container">
        <h1>Login by account</h1>
        <form id="login-Form">
            <input id="nickname-Account" type="text" placeholder="Enter your Nickname" />
            <input id="nickname-Password" type="password" placeholder="Enter your password" />
            <button type="submit">Submit</button>
        </form>
        <span id="using-nickname"
            style="display: flex;justify-content:center;margin-top:10px;color:blue;cursor:pointer">Don't
            want to login?
            Try use nick
            name</span>
    </div>
</body>
<script src="https://warp.cs.au.dk/libs/warptalk.js" type="application/javascript"></script>
<script type="module">
    import { wt } from './js/global-params.js';

    const loginForm = document.getElementById('login-Form');
    const nicknameAccount = document.getElementById('nickname-Account');
    const nicknamePassword = document.getElementById('nickname-Password');
    /**
    * I chose to set the nick name and login name in local cache, just becuase its handy
    */
    // Handle form submission
    const nickname_e = document.getElementById("using-nickname");
    nickname_e.addEventListener("click", function (e) {
        let nickname = prompt("What's your (unregistered) nickname?");
        nickname = nickname.trim();

        wt.connect(() => {
            window.location.href = "./warpchat.html";
            localStorage.setItem('nickName', nickname);
        }, nickname);

    })

    function login(nickname, password) {
        return fetch(wt._baseURL + '/login', {
            method: 'POST',
            mode: 'cors',
            cache: 'no-cache',
            credentials: 'include',
            headers: {
                "Content-Type": 'application/json'
            },
            body: JSON.stringify({ nickname, password })
        });
    }



    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // prevent the default behavior
        let nicknameAccountValue = nicknameAccount.value.trim();
        let nicknamePasswordValue = nicknamePassword.value.trim();

        if (nicknameAccountValue === "" || nicknamePasswordValue === "") {
            alert("Please input a valid name or password!");
        } else {


            let res = await login(nicknameAccountValue, nicknamePasswordValue);
            console.log(res)
            if (res.status === 200) {
                await wt.isLoggedIn(function (isLoggedIn) {
                    // console.log(isLoggedIn)
                    //if (isLoggedIn) {
                    //   // Connect and redirect to the chat page
                    //   wt.connect(() => {
                    //       window.location.href = "./warpchat.html";
                    //      // Save login name to localStorage
                    //     localStorage.setItem('login', nicknameAccountValue);
                    //  }, nicknameAccountValue);
                    //   } else {
                    //     // impossible
                    //  alert("network fluctate!")
                    //  }

                    wt.connect(() => {
                        window.location.href = "./warpchat.html";
                        // Save login name to localStorage
                        localStorage.setItem('login', nicknameAccountValue);
                    }, nicknameAccountValue);
                })
            } else {
                alert("Login failed. Please check your name or password.");
            }

        }
    });




</script>

</html>