<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Chat Interface</title>
    <link rel="stylesheet" type="text/css" href="./css/warp_chat_style.css">

</head>

<body>

    <div class="server-side">
        <span>Aarhus Universitet :)</span>
    </div>

    <div class="channel-side">
        <!-- Channel List -->
        <div class="channel-list">
            <div style="padding-top: 15px; padding-left: 15px; padding-right: 15px;">
                <div class="channel-header-container">
                    <img class="icon-authentication" src="/static/icon/authentication.png" alt="authentication">
                    <span>Warp Talk</span>
                </div>
                <div id="room-list"></div>
            </div>

            <div
                style="background-color:rgb(36,39,48);display:flex;align-items:center;position:absolute;bottom:0;width:100%;height:8% ">
                <div id="client-area" style="display: flex;flex-direction:column;margin-left:2% ">
                    <span id="client-name" style="color: white;font-size:15px">Client Name:</span>
                    <span id="client-status" style="color:rgb(179, 187, 197);font-size:12px">Online</span>
                </div>

            </div>
        </div>
        <div style="display: flex;width:100vw">
            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Chat Header -->
                <div class="chat-header">
                    <span id="chat-header-text" style="color:white;font-size:17px;font-weight:300;">
                    </span>
                    <div style="display: flex;gap:8px;position:absolute;right:15px;align-items:center">
                        <img id="show-clients" class="show-clients" style="height: 20px; width: 20px;margin-right:7px"
                            src="/static/icon/people.png" title="show clients" alt="">
                        <img id="leave" class="show-clients" style="height: 20px; width: 20px;margin-right:7px"
                            src="/static/icon/leave.png" title="reset the nickname" alt="">
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages">
                    <div id="message-list" class="message">

                    </div>
                </div>


                <!-- Message Input -->
                <div style="display: flex;">
                    <div style="position:relative;width: 90%;">
                        <div class="message-input">
                            <input id="msg-input" type="text" placeholder="Say hello to everyone">
                        </div>
                    </div>
                    <div
                        style="width:7%;display:flex;justify-content:center;align-items:center; background-color: #40444B;border-radius:10px;margin-bottom:10px;margin-left:1vw;cursor: pointer;">
                        <span id="send-button" style="color: white; font-size: 16px;">send</span>
                    </div>
                </div>
            </div>
            <div style="display: none;" id="client-list" class="client-list">
            </div>
        </div>
    </div>
</body>
<!-- Load your custom JavaScript after the library -->
<script src="https://warp.cs.au.dk/libs/warptalk.js" type="application/javascript"></script>
<script type="module">
    import { wt } from './js/global-params.js';
    let current_room;
    let room_list = [];

    console.log("Connecting to the WarpTalk server ...");
    let nickname = localStorage.getItem('nickName'); // Retrieve the nickname from localStorage

    // if there's no nickname while the first page loaded, force users back to the regist page
    document.addEventListener('DOMContentLoaded', function () {
        if (nickname === null || nickname === undefined) {
            alert("please enter the nickname before using")
            window.location.href = "./login.html"
        }
    })

    wt.connect(connected, nickname);

    // This function is called when the connection to the server is established.
    async function connected() {
        console.log("Connection established.");

        room_list = wt.availableRooms;
        let room = wt.join(wt.availableRooms[0].name);
        current_room = room;

        // Render rooms, clients, and messages after connecting
        setTimeout(() => {
            renderRooms();
            printCurrentClients();
        }, 30);

        document.getElementById("chat-header-text").innerHTML = `&nbsp;${current_room.name}
                <span style="color:rgb(179, 187, 197);font-size:14px;font-weight:200;"> | ${current_room.description}</span>`;

        setTimeout(() => {
            joinRoom();
            printCurrentClients();
        }, 40);

        setTimeout(() => {
            receiveMessage();
            printCurrentClients();
        }, 50);

        setTimeout(() => {
            leaveRoom();
            printCurrentClients();
        }, 60);

        // CLIENT NAME
        document.getElementById('client-name').innerHTML = "Client Name: " + nickname;

        window.send = function (msg) {
            room.send(msg);
        };
        window.login = function (username, password) {
            wt.login(username, password);
        };
        window.logout = function () {
            wt.logout();
        };
    }

    // Handle sending messages on Enter key press
    const msgInputElement = document.getElementById("msg-input");
    msgInputElement.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            const message = msgInputElement.value.trim();
            current_room.send(message);
            msgInputElement.value = '';
        }
    });

    const sendButtonElement = document.getElementById("send-button");
    sendButtonElement.addEventListener("click", (e) => {

        e.preventDefault();
        const message = msgInputElement.value.trim();
        current_room.send(message);
        msgInputElement.value = '';

    })

    // Function for rendering all rooms
    function renderRooms() {
        const roomListElement = document.getElementById("room-list");
        let current_room_name = current_room.name;

        roomListElement.innerHTML = ''; // Clear room list

        room_list.forEach(r => {
            if (r.name === current_room_name) {
                roomListElement.innerHTML += `
            <div id="${r.name}" class="channel active" style="pointer-events: none;">
                <span style="color: white; font-size: 13px;">${r.name}</span>
            </div>`;
            } else {
                roomListElement.innerHTML += `
            <div id="${r.name}" class="channel">
                <span style="color: white; font-size: 13px;">${r.name}</span>
            </div>`;
            }
        });
    }

    // Handle changing room
    document.getElementById("room-list").addEventListener('click', function (e) {
        const clickedElement = e.target;
        const idString = clickedElement.id;
        if (idString !== "") {
            room_list.forEach(r => {
                if (idString === r.name) {
                    current_room.listeners = [];
                    current_room.joinListeners = [];
                    current_room.leaveListeners = [];

                    // wt.leave(current_room.name);

                    current_room = wt.join(idString);

                    setTimeout(() => joinRoom(), 50);
                    setTimeout(() => receiveMessage(), 60);
                    setTimeout(() => printCurrentClients(), 70);

                    document.getElementById("message-list").innerHTML = ""; // Clear messages

                    renderRooms();
                    document.getElementById("chat-header-text").innerHTML = `&nbsp;${current_room.name}
                <span style="color:rgb(179, 187, 197);font-size:14px;font-weight:200;"> | ${current_room.description}</span>`;
                }
            });
        }
    });

    // Handle receiving messages
    function receiveMessage() {
        current_room.onMessage((room, msg) => {
            const current_room_name = current_room.name;
            const messageContent = `
            <div style="margin-left: 10px; margin-top: 10px">
                <span style="font-weight: 500; color: ${msg.sender === nickname ? '#d29e4f' : '#518948'}; font-size: 17px">${msg.sender}</span>
                <span class="timestamp">${new Date().toLocaleString('en-GB', { hour: 'numeric', minute: 'numeric', hour12: true })}</span>
                <div class="content">${msg.message}</div>
            </div>`;
            if (msg.room === current_room_name) {
                document.getElementById("message-list").innerHTML += messageContent;
            }
        });
    }

    // Handle joining room
    function joinRoom() {
        document.getElementById("message-list").innerHTML += `<div style="font-size:12px;display:flex;justify-content:center;color:grey"> <span>${nickname} joined ${current_room.name}</span></div>`;
        current_room.onJoin((room, nickname) => {
            if (document.querySelector('#room-list .channel.active').id === room.name) {
                document.getElementById("message-list").innerHTML += `<div style="font-size:12px;display:flex;justify-content:center;color:grey"><span>${nickname} joined ${room.name}</span></div>`;
            }
            printCurrentClients()
        });
    }

    // Handle leaving room
    function leaveRoom() {
        current_room.onLeave((room, nickname) => {
            console.log(room, nickname);
            if (document.querySelector('#room-list .channel.active').id === room.name) {
                document.getElementById("message-list").innerHTML += `<div style="font-size:12px;display:flex;justify-content:center;color:grey"><span>${nickname} left ${room.name}</span></div>`;
            }

            printCurrentClients()
        });
    }

    // Function for printing current clients
    function printCurrentClients() {
        const clients = current_room.clients || [];
        console.log(current_room)
        let client_list_element = document.getElementById("client-list");
        client_list_element.innerHTML = ""; // Clear the client list
        client_list_element.innerHTML += `<div style="display:flex;justify-content:center;font-size:17px;margin-bottom:10px;" >client list</div>`;
        clients.forEach(client => {
            client_list_element.innerHTML += `<div class="client-list-item">${client.nickname}</div>`;
        });
    }

    // Toggle client list visibility
    document.getElementById('show-clients').addEventListener('click', function (e) {
        this.classList.toggle('active');
        let client_list_side = document.getElementById("client-list");
        client_list_side.style.display = this.classList.contains('active') ? "block" : "none";
        this.src = this.classList.contains('active') ? '/static/icon/people-active.png' : '/static/icon/people.png';
    });

    // back to the regist page
    document.getElementById('leave').addEventListener('click', function (e) {
        localStorage.removeItem('nickName')
        window.location.href = "./login.html";
    })
    /**
        I'm trying to write a drop and reconnect, but there doesn't seem to be a corresponding method.
    */


</script>

</html>